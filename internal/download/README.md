# 可降级的下载器设计说明

## 设计目标

下载器应针对不同的情况限制其并发能力并避免非必要下载

## 术语

并发能力：指下载器在用户的配置下，同时下载多条视频，但是每条视频只使用一个TCP连接。
可能会同时有多个不同站点的并发队列同时进行，所以实际TCP连接数可能会超过用户配置。

---

下载ETA：根据最近下载速度计算的一首歌完成完整下载的预计时刻

播放ETA：一首歌开始播放时刻的最坏估计，即如果无法确定当前播放播放进度，默认已经播放完成，
但是默认其他歌曲不会被移除或提前结束

恢复下载ETA：根据并发数量、已知的下载ETA、队列位置，计算的一首歌从暂停状态恢复下载的时刻的乐观估计

---

后缀下载：在启用片段式缓存时，歌曲从中途播放，触发下载器优先从请求位置开始下载

后缀下载的完成：下载器可以确保未播放内容均已下载

非必要下载：当前播放的视频已经完成后缀下载，开始补全其余未下载部分

## 状况处理

### 服务器限流

#### 解释

PyPyDance的CDN遇到短时多次的请求，会暂时性封锁IP（应该是3分钟），下载器应合理延长请求之间的间隔

#### 条件

任意请求出现服务器返回429

#### 处理（间隔延长）

由entry感知并以ErrThrottle结束下载流，告知下载器，下载器延长未来请求的间隔（可叠加），3分钟后减回去

### 网络拥塞

#### 解释

网络链路带宽占满，出现稳定的低下载速度，使用并发下载反而会均分带宽，单曲下载变慢

#### 条件

当前歌曲未完成下载，或者下一首歌曲无法在播放ETA之前至少下载20秒

#### 处理（并发降级）

由定期的ETA检查发现，下载器降级并发能力，暂停除当前歌曲和下一首歌曲外的下载，
如果当前歌曲进入非必要下载状态，也要暂停。

直到条件不再满足，解除并发能力降级。

### 拥塞窗口缩小

#### 解释

长时间下载可能使拥塞窗口越来越小，重新请求可能会得到更大的窗口

#### 条件

正在下载的歌曲的下载时间超过3分钟时

下载ETA在播放结束时刻之后，且已经下载了30秒

限流状态下不能触发

#### 处理（重启）

由定期的ETA检查发现，关闭当前的下载流，然后再次启动下载。

### 闲置连接

#### 解释

如果下载过程由于优先级变化而被暂停，下载流不会被关闭，TCP连接会被保持，如果持续太久可能会对服务器造成不必要的压力

#### 条件

恢复下载ETA距离暂停时超过30秒，或者已经暂停30秒却没有关闭下载流

#### 处理（重启后暂停）

处理方式同重启，只不过任务会在重启后暂停

### 过期缓存

#### 解释

下载器通过检查Last-Modified或者视频上传日期，避免缓存与实际不一致

#### 条件

缓存文件的ModTime早于Last-Modified，且文件未完整下载，或者用户启用过期回源

#### 处理（重置进度）

强制清空文件，从头下载
